import{_,a as i,c as n,b as l,w as U,j as w,v as g,F as y,r as k,e as L,t as R,d as p,u as x}from"./index-CrVrwAiP.js";import{p as j,u as C}from"./index-NDcc4Jqj.js";const O={class:"publish-page"},V={class:"card"},W={class:"form-group"},B={class:"form-group"},F={key:0,class:"preview-list"},M=["src"],D={key:1,class:"preview-video-placeholder"},E=["onClick"],I=["disabled"],N={__name:"Publish",setup(P){const m=x(),c=p(""),a=p([]),u=p(!1);function d(s){const e=s.serverUrl||"";return e.includes("video")||e.endsWith(".mp4")||e.endsWith(".webm")}function b(s){const e=a.value[s];e.previewUrl&&e.previewUrl.startsWith("blob:")&&URL.revokeObjectURL(e.previewUrl),a.value.splice(s,1)}async function f(s){const e=Array.from(s.target.files||[]),t=9-a.value.length;if(!(t<=0)){for(const o of e.slice(0,t)){const r=URL.createObjectURL(o);try{const{data:v}=await C(o);a.value.push({serverUrl:v.url,previewUrl:r})}catch(v){URL.revokeObjectURL(r),console.error(v)}}s.target.value=""}}async function h(){var s,e;if(!c.value.trim()&&a.value.length===0){alert("请填写内容或上传图片/视频");return}u.value=!0;try{const t=a.value.map(r=>r.serverUrl),o=t.some(r=>d({serverUrl:r}))?"video":"image";await j.create({content:c.value.trim(),type:o,media_urls:t,topic_names:[]}),a.value.forEach(r=>{r.previewUrl&&r.previewUrl.startsWith("blob:")&&URL.revokeObjectURL(r.previewUrl)}),m.push("/")}catch(t){alert(((e=(s=t.response)==null?void 0:s.data)==null?void 0:e.error)||"发布失败")}finally{u.value=!1}}return(s,e)=>(i(),n("div",O,[e[3]||(e[3]=l("h1",{class:"page-title"},"发帖",-1)),l("div",V,[l("form",{onSubmit:U(h,["prevent"]),class:"publish-form"},[l("div",W,[e[1]||(e[1]=l("label",{for:"publish-content"},"内容",-1)),w(l("textarea",{id:"publish-content","onUpdate:modelValue":e[0]||(e[0]=t=>c.value=t),rows:"4",placeholder:"写点什么...",class:"publish-textarea"},null,512),[[g,c.value]])]),l("div",B,[e[2]||(e[2]=l("label",null,"图片 / 视频（最多 9 张图或 1 个视频）",-1)),l("input",{type:"file",accept:"image/*,video/*",multiple:"",onChange:f,class:"file-input","aria-label":"选择图片或视频"},null,32),a.value.length?(i(),n("div",F,[(i(!0),n(y,null,k(a.value,(t,o)=>(i(),n("div",{key:o,class:"preview-item"},[d(t)?(i(),n("div",D,"视频")):(i(),n("img",{key:0,src:t.previewUrl,alt:"预览",class:"preview-img"},null,8,M)),l("button",{type:"button",class:"preview-remove",onClick:r=>b(o),"aria-label":"移除"},"×",8,E)]))),128))])):L("",!0)]),l("button",{type:"submit",class:"btn btn-primary",disabled:u.value},R(u.value?"发布中...":"发布"),9,I)],32)])]))}},T=_(N,[["__scopeId","data-v-65b114c0"]]);export{T as default};
